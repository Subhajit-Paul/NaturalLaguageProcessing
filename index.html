<!DOCTYPE html>
<html>
    <html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
{% load static %}
<link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">
<link href="{% static 'css/bootstrap-utilities.css' %}" rel="stylesheet">
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'css/dropdown.css' %}" rel="stylesheet">
<link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" />
<script type="text/javascript" src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

<head>
    <title>Predict The Word!!</title>
</head>
    
<body>
    <h1 class="panel-title fw-bold text-center mt-5">Bi-Gram RNN Model To Generate Next Predicted Word [Prototype 3]</h1>
        <div class="container fs-4 mt-5 height-150 d-flex align-items-center justify-content-center">
        <textarea type="text" rows=3 cols=53 id="messageText" placeholder="Enter Words Here"></textarea>
        </div>
        <div class="text-center mx-auto w-75 mt-3 hovered">
            <select name = "" class="fs-6 fw-bold form-control form-select mt-3 text-center btn-outline-white btn-light shadow w-25 align-middle mx-auto text" onchange="appendLastWord(this.value); this.selectedIndex=0;" id = "select" data-toggle="dropdown" multiple>
                <OPTION></OPTION>
            </select>
        </div>   
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close shadow-lg" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="exampleModalLabel" >Enter Sentence</label>
                        <input type="text" id="textField" class="form-control">
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="tryit()" data-bs-dismiss="modal" class="btn btn-primary shadow-sm">Save changes</button>
                    </div>
                </div>
            </div>
        </div> 
        <div class="text-center mx-auto w-75 mt-3 hovered">      
            <button type="button" class="btn btn-warning shadow-sm btn-outline-secondary rounded-10" data-bs-toggle="modal" id = "modalBtn" data-bs-target="#exampleModal">
                Add Sentence To Dictionary
            </button>
        </div>
    
      <script>
            var host = "127.0.0.1";
            var tarea = document.getElementById("messageText");
            var ws = new WebSocket("ws://"+host+":8000/ws");
            var savingUnknown = new WebSocket("ws://"+host+":8000/savetovar");
            var rw = new WebSocket("ws://"+host+":8000/rw");
            
            setTimeout( () => {
                rw.send('read')
            }, 500);

            setInterval( () => {
                rw.send('write');
                rw.send('read');
            }, 60000);
            
            function tryit(){
                var textOfModal = document.getElementById("textField").value.toLowerCase();
                if(textOfModal.split(" ").length < 2) alert("Please enter at least 2 words");
                else savingUnknown.send(textOfModal);
                document.getElementById("textField").value = ""
            }

            function appendLastWord(value){
                if(value === "No Results Found From model!!"){
                    document.getElementById("modalBtn").click(); 
                }
                else if(value === "Select"){
                    passed = true;
                }
                else {
                    if(tarea.value[tarea.value.length-1] === " "){
                        tarea.value += value;
                    }
                    else{
                        tarea.value += " " + value;
                    }                    
                }
            }

            ws.onmessage = function(event){
                var select = document.getElementById("select");
                document.getElementById("select").options.length=0;
                var arr = JSON.parse(event.data);
                select.size = arr.length + 1;
                for(var i = 0; i <= arr.length; i++)
                {
                    if(i == 0){
                        var option = document.createElement("OPTION");
                            txt = document.createTextNode("");
                        option.appendChild(txt);
                        option.setAttribute("value","Select");
                        select.insertBefore(option,select.lastChild);
                    }
                    else{
                        var option = document.createElement("OPTION");
                            txt = document.createTextNode(arr[i - 1].word);
                        option.appendChild(txt);
                        option.setAttribute("value",arr[i - 1].word);
                        select.insertBefore(option,select.lastChild);
                    }
                    
                }
            };
                let timer;
                var inpt = window.document.getElementById("messageText");                
                inpt.addEventListener("keydown", clearTimeout(timer));

                inpt.addEventListener("keyup", timer = () => setTimeout(() => {                        
                        var lword = inpt.value.split(" ");
                        lword = Array.from(new Set(lword));
                        if(lword.length >= 1 && inpt.value != ""){
                            if(lword[lword.length - 1] == ""){
                                lword.pop();
                            }
                            var sendit = lword[lword.length - 1].toLowerCase();
                            ws.send(sendit);                           
                        }  
                    }, 100)
                );

        </script>
    </body>
</html>